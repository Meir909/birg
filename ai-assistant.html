<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî Birge</title>
<link rel="stylesheet" href="style.css">
<style>
.chat-wrap { display:flex; height:calc(100vh - 64px); }
.chat-sidebar { width:260px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);padding:1rem;overflow-y:auto; }
.chat-main { flex:1;display:flex;flex-direction:column;overflow:hidden; }
.chat-header { padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:1rem;flex-shrink:0; }
.chat-messages { flex:1;overflow-y:auto;padding:1.5rem; }
.chat-input-area { padding:1rem 1.5rem;border-top:1px solid var(--border);background:var(--bg2);flex-shrink:0; }
.msg { display:flex;gap:0.75rem;margin-bottom:1.25rem;animation:fadeIn 0.3s ease; }
.msg.user { flex-direction:row-reverse; }
.msg-bubble { max-width:75%;padding:0.75rem 1rem;border-radius:16px;font-size:0.875rem;line-height:1.6;white-space:pre-wrap;word-break:break-word; }
.msg.ai .msg-bubble { background:var(--card);border:1px solid var(--border);border-radius:16px 16px 16px 4px; }
.msg.user .msg-bubble { background:var(--accent);color:white;border-radius:16px 16px 4px 16px; }
.quick-btns { display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.75rem; }
.quick-btn { background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);color:var(--ai2);padding:0.4rem 0.8rem;border-radius:20px;font-size:0.8rem;cursor:pointer;transition:all 0.2s;white-space:nowrap; }
.quick-btn:hover { background:rgba(139,92,246,0.2); }
.history-item { padding:0.6rem 0.75rem;border-radius:var(--radius-sm);font-size:0.82rem;color:var(--text2);cursor:pointer;transition:all 0.2s;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.history-item:hover { background:var(--bg3);color:var(--text); }
.chat-input { width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);padding:0.75rem 1rem;font-family:var(--font-body);font-size:0.9rem;resize:none;transition:border-color 0.2s; }
.chat-input:focus { outline:none;border-color:var(--ai); }
.typing-dots span { display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--text3);margin:0 2px;animation:typingBounce 1.2s ease-in-out infinite; }
.typing-dots span:nth-child(2){animation-delay:0.2s}
.typing-dots span:nth-child(3){animation-delay:0.4s}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.send-btn { padding:0.75rem 1.1rem;background:linear-gradient(135deg,var(--ai),#6D28D9);color:white;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:1rem;transition:all 0.2s;flex-shrink:0; }
.send-btn:hover:not(:disabled) { transform:translateY(-1px);box-shadow:0 4px 12px rgba(139,92,246,0.4); }
.send-btn:disabled { opacity:0.5;cursor:not-allowed; }
</style>
</head>
<body>
<script src="gemini.js"></script>
<nav class="navbar">
  <a href="index.html" class="nav-logo">üöó Birge</a>
  <div style="display:flex;align-items:center;gap:0.75rem;">
    <div class="ai-label"><span class="ai-pulse"></span> AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
    <div id="key-badge"></div>
  </div>
  <a href="dashboard.html" class="btn btn-secondary btn-sm">‚Üê –î–∞—à–±–æ—Ä–¥</a>
</nav>

<div class="chat-wrap">
  <div class="chat-sidebar">
    <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:0.75rem;">–ò—Å—Ç–æ—Ä–∏—è</div>
    <button class="btn btn-ai btn-sm" style="width:100%;margin-bottom:1rem;" onclick="newChat()">+ –ù–æ–≤—ã–π —á–∞—Ç</button>
    <div id="chat-history"></div>
  </div>

  <div class="chat-main">
    <div class="chat-header">
      <div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--ai),#6D28D9);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;">ü§ñ</div>
      <div style="flex:1;">
        <div style="font-family:var(--font-display);font-weight:700;">Birge AI ¬∑ Gemini 2.0 Flash</div>
        <div id="status-text" style="font-size:0.78rem;color:var(--accent2);">‚óè –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
      </div>
    </div>

    <div class="chat-messages" id="messages"></div>

    <div style="padding:0 1.5rem 0.5rem;">
      <div class="quick-btns">
        <button class="quick-btn" onclick="sendQuick(this)">üîç –ù–∞–π—Ç–∏ –ø–æ–µ–∑–¥–∫—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 8:00</button>
        <button class="quick-btn" onclick="sendQuick(this)">üó∫Ô∏è –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –º–æ–π –º–∞—Ä—à—Ä—É—Ç</button>
        <button class="quick-btn" onclick="sendQuick(this)">üë• –ö–æ–≥–æ –≤–∑—è—Ç—å –≤ –≥—Ä—É–ø–ø—É?</button>
        <button class="quick-btn" onclick="sendQuick(this)">‚õΩ –°–∫–æ–ª—å–∫–æ —Å—ç–∫–æ–Ω–æ–º–ª—é —Ç–æ–ø–ª–∏–≤–∞?</button>
        <button class="quick-btn" onclick="sendQuick(this)">üõ°Ô∏è –ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ?</button>
        <button class="quick-btn" onclick="sendQuick(this)">üìç –ì—Ä—É–ø–ø—ã –≤ –º–æ—ë–º —Ä–∞–π–æ–Ω–µ –ú–µ–¥–µ—É</button>
      </div>
    </div>

    <div class="chat-input-area">
      <div style="display:flex;gap:0.75rem;align-items:flex-end;">
        <textarea class="chat-input" rows="2" id="msg-input"
          placeholder='–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å... –ù–∞–ø—Ä–∏–º–µ—Ä: "–ù–∞–π–¥–∏ –ø–æ–µ–∑–¥–∫—É –≤ –®–∫–æ–ª—É ‚Ññ5 –≤ –ø—è—Ç–Ω–∏—Ü—É"'
          onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMsg()">‚Üí</button>
      </div>
      <div style="font-size:0.72rem;color:var(--text3);margin-top:0.4rem;text-align:center;">
        Birge AI ¬∑ Gemini 2.0 Flash ¬∑ <span id="msg-count">0 —Å–æ–æ–±—â–µ–Ω–∏–π</span>
      </div>
    </div>
  </div>
</div>

<script>
let chatHistory = [];
let savedChats = [];
try { savedChats = JSON.parse(sessionStorage.getItem('birge_chats') || '[]'); } catch(_) {}
let isLoading = false;

renderApiKeyBadge('key-badge');
renderHistory();

if (!hasApiKey()) {
  addAIMsg('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Birge AI!\n\n–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –¥–æ–±–∞–≤—å—Ç–µ Gemini API –∫–ª—é—á.\n\n–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ aistudio.google.com ‚Üí –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á¬ª –≤–≤–µ—Ä—Ö—É.');
  renderApiKeyModal(() => location.reload());
} else {
  addAIMsg('üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Birge –Ω–∞ –±–∞–∑–µ Gemini 2.0 Flash.\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\nüîç –ù–∞–π—Ç–∏ –ø–æ–µ–∑–¥–∫—É\nüó∫Ô∏è –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç\nüë• –ü–æ–¥–æ–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—É\n‚ùì –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ');
}

function aiAvatar() {
  return `<div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--ai),#6D28D9);display:flex;align-items:center;justify-content:center;font-size:0.9rem;flex-shrink:0;">ü§ñ</div>`;
}

function addAIMsg(text) {
  const msgs = document.getElementById('messages');
  const d = document.createElement('div');
  d.className = 'msg ai';
  d.innerHTML = aiAvatar() + `<div><div style="font-size:0.72rem;color:var(--text3);margin-bottom:0.3rem;">Birge AI ¬∑ ${now()}</div><div class="msg-bubble">${fmt(text)}</div></div>`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

function addUserMsg(text) {
  const msgs = document.getElementById('messages');
  const d = document.createElement('div');
  d.className = 'msg user';
  d.innerHTML = `<div class="msg-bubble">${esc(text)}</div>`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTyping() {
  const msgs = document.getElementById('messages');
  const d = document.createElement('div');
  d.className = 'msg ai'; d.id = 'typing';
  d.innerHTML = aiAvatar() + `<div class="msg-bubble" style="padding:1rem 1.25rem;"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

async function sendMsg() {
  if (isLoading) return;
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  if (!text) return;
  if (!hasApiKey()) { renderApiKeyModal(() => location.reload()); return; }

  inp.value = '';
  addUserMsg(text);
  chatHistory.push({ role: 'user', content: text });

  isLoading = true;
  document.getElementById('send-btn').disabled = true;
  setStatus('‚óè –î—É–º–∞—é...', 'var(--ai2)');
  showTyping();

  try {
    const reply = await geminiChat(chatHistory, SYSTEM_PROMPTS.assistant);
    document.getElementById('typing')?.remove();
    addAIMsg(reply);
    chatHistory.push({ role: 'assistant', content: reply });

    if (chatHistory.length === 2) {
      savedChats.unshift({ title: text.slice(0, 40), messages: [...chatHistory] });
      if (savedChats.length > 10) savedChats.pop();
      sessionStorage.setItem('birge_chats', JSON.stringify(savedChats));
      renderHistory();
    }

    const count = Math.floor(chatHistory.length / 2);
    document.getElementById('msg-count').textContent = count + ' ' + plural(count, '—Å–æ–æ–±—â–µ–Ω–∏–µ','—Å–æ–æ–±—â–µ–Ω–∏—è','—Å–æ–æ–±—â–µ–Ω–∏–π');
    setStatus('‚óè –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'var(--accent2)');
  } catch (e) {
    document.getElementById('typing')?.remove();
    const err = geminiError(e);
    addAIMsg('‚ö†Ô∏è ' + err.text);
    if (err.needsKey) renderApiKeyModal(() => location.reload());
    setStatus('‚óè –û—à–∏–±–∫–∞', 'var(--accent3)');
  }

  isLoading = false;
  document.getElementById('send-btn').disabled = false;
}

function sendQuick(btn) {
  document.getElementById('msg-input').value = btn.textContent.trim();
  sendMsg();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
}

function newChat() {
  chatHistory = [];
  document.getElementById('messages').innerHTML = '';
  document.getElementById('msg-count').textContent = '0 —Å–æ–æ–±—â–µ–Ω–∏–π';
  addAIMsg('–ù–æ–≤—ã–π —á–∞—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä');
}

function loadChat(idx) {
  const c = savedChats[idx];
  if (!c) return;
  chatHistory = [...c.messages];
  document.getElementById('messages').innerHTML = '';
  for (const m of chatHistory) {
    if (m.role === 'user') addUserMsg(m.content);
    else addAIMsg(m.content);
  }
}

function renderHistory() {
  const el = document.getElementById('chat-history');
  if (!savedChats.length) { el.innerHTML = '<div style="font-size:0.78rem;color:var(--text3);padding:0.5rem 0.75rem;">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏</div>'; return; }
  el.innerHTML = savedChats.map((c,i) => `<div class="history-item" onclick="loadChat(${i})">üí¨ ${esc(c.title)}...</div>`).join('');
}

function setStatus(t, c) {
  const el = document.getElementById('status-text');
  el.textContent = t; el.style.color = c;
}

function now() { return new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'}); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmt(s) {
  return esc(s)
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/\n/g,'<br>');
}
function plural(n, a, b, c) { return n===1?a:(n>=2&&n<=4)?b:c; }
</script>
</body>
</html>